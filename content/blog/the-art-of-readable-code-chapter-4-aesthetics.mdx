---
title: "The Art Of Readable Code - Chapter 4: Aesthetics (Tính thẩm mỹ)"
description: "Trong chương này, chúng ta sẽ tập trung vào những cải tiến mang tính “thẩm mỹ” cho code. Những cải tiến này rất dễ thực hiện và thường cải thiện khả năng đọc code khá nhiều."
date: "2023-09-24"
image: /images/blog/clean-code-chapter-4.jpg
authors:
  - taitd
series:
  order: 1
  title: "The Art Of Readable code"
---

Trong chương này, chúng ta sẽ tập trung vào những cải tiến mang tính “thẩm mỹ” cho code. Những cải tiến này rất dễ thực hiện và thường cải thiện khả năng đọc code khá nhiều.

## Tại sao tính thẩm mỹ lại quan trọng?

Hãy so sánh 2 đoạn code sau:

```java showLineNumbers
class StatsKeeper {
public:
// A class for keeping track of a series of doubles
    void Add(double d); // and methods for quick statistics about them
   private: int count;        /* how many so far
 */ public:
        double Average();

private:    double minimum;
list<double>
  past_items
  ;double maximum;
};
```

```java showLineNumbers
// A class for keeping track of a series of doubles
// and methods for quick statistics about them.
class StatsKeeper {
  public: void Add(double d);
  double Average();
  private: list <double> past_items;
  int count; // how many so far
  double minimum;
  double maximum;
};
```

## Ngắt dòng một cách nhất quán và gọn gàng

Giả sử mình có một đoạn code Java như sau:

```java showLineNumbers
public class PerformanceTester {
	public static final TcpConnectionSimulator wifi = new TcpConnectionSimulator(
		500, /* Kbps */
        80, /* millisecs latency */
        200, /* jitter */
        1 /* packet loss % */);
	public static final TcpConnectionSimulator t3_fiber =
	  new TcpConnectionSimulator(
	        45000, /* Kbps */
            10, /* millisecs latency */
            0, /* jitter */
            0 /* packet loss % */);
	public static final TcpConnectionSimulator cell = new TcpConnectionSimulator(
	    100, /* Kbps */
        400, /* millisecs latency */
        250, /* jitter */
        5 /* packet loss % */);
}
```

Đây là một lớp Java có tên `PerformanceTester` định nghĩa ba đối tượng `TcpConnectionSimulator` có tên `wifi`, `t3_fiber` và `cell`.

`TcpConnectionSimulator` constructor nhận vào 4 bốn đối số:

- Băng thông tính bằng Kbps,
- Độ trễ tính bằng mili giây
- jitter tính bằng mili giây
- Packet loss tính theo phần trăm.

Ở ví dụ trên, định nghĩa về `t3_fiber` trông có vẻ khác với những đối tượng khác như `wifi` và `cell` khiến nó trở nên kỳ quặc mà không có lý do đặc biệt nào, điều này trái với nguyên tắc “similar code should look similar.” - tức là những đoạn code tương tự nhau thì phải nhìn tương tự nhau.

Để làm code trở nên nhất quán hơn, chúng ta có thể sửa lại line break như sau:

```java showLineNumbers
public class PerformanceTester {
    public static final TcpConnectionSimulator wifi =
        new TcpConnectionSimulator(
            500, /* Kbps */
            80, /* millisecs latency */
            200, /* jitter */
            1 /* packet loss % */);
    public static final TcpConnectionSimulator t3_fiber =
        new TcpConnectionSimulator(
            45000, /* Kbps */
            10, /* millisecs latency */
            0, /* jitter */
            0 /* packet loss % */);
    public static final TcpConnectionSimulator cell =
        new TcpConnectionSimulator(
            100, /* Kbps */
            400, /* millisecs latency */
            250, /* jitter */
            5 /* packet loss % */);
}
```

Nhìn có vẻ ổn hơn nhiều rồi nhưng mà các đối số đang bị break line khiến code có cảm giác nhìn dài hơn, và các comment cũng đang bị duplicate.

Mình sẽ đặt các comment lên trên đầu hàm, và các đối số trên cùng một dòng, và đây là code "vở sạch chữ đẹp" cho ví dụ trên:

```java showLineNumbers
public class PerformanceTester {
    // TcpConnectionSimulator(throughput, latency, jitter, packet_loss)
    //                            [Kbps]    [ms]    [ms]    [percent]

    public static final TcpConnectionSimulator wifi =
        new TcpConnectionSimulator(500,     80,     200,    1);

    public static final TcpConnectionSimulator t3_fiber =
        new TcpConnectionSimulator(45000,   10,     0,      0);

    public static final TcpConnectionSimulator cell =
        new TcpConnectionSimulator(100,     400,    250,    5);
}
```

## Tách method để xoá bỏ sự bất thường

Giả sử trong cơ sở dữ liệu có một function như sau:

```java showLineNumbers
// Turn a partial_name like "Doug Adams" into "Mr. Douglas Adams".
// If not possible, 'error' is filled with an explanation.
string ExpandFullName(DatabaseConnection dc, string partial_name, string* error);
```

Viết unit test với hàm trên:

```java showLineNumbers
DatabaseConnection database_connection;
string error;
assert(ExpandFullName(database_connection, "Doug Adams", &error)
    == "Mr. Douglas Adams");
assert(error == "");
assert(ExpandFullName(database_connection, " Jake Brown ", &error)
    == "Mr. Jacob Brown III");
assert(error == "");
assert(ExpandFullName(database_connection, "No Such Guy", &error) == "");
assert(error == "no match found");
assert(ExpandFullName(database_connection, "John", &error) == "");
assert(error == "more than one result");
```

Đoạn code trên kiểm tra xem giá trị trả về từ hàm `ExpandFullName` có đúng với giá trị mong đợi hay không, nếu không đúng thì chuỗi `error` sẽ được cập nhật.

Đoạn code trên không có tính thẩm mỹ. Một số dòng qúa dài nên nó bị wrap xuống dòng tiếp theo, khiến cho tổng thể nhìn không được nhất quán, ngoài ra thì còn một vấn đề nữa đó là method `assert(ExpandFullName(database_connection, ...)` đang bị lặp lại quá nhiều lần.

Để cải thiện đoạn code trên, chúng ta cần tách riêng ra một method như thế này:

```java showLineNumbers
void CheckFullName(string partial_name,
    string expected_full_name,
    string expected_error) {
    // database_connection is now a class member
    string error;
    string full_name = ExpandFullName(database_connection, partial_name, &error);
    assert(error == expected_error);
    assert(full_name == expected_full_name);
}

CheckFullName("Doug Adams", "Mr. Douglas Adams", "");
CheckFullName(" Jake Brown ", "Mr. Jake Brown III", "");
CheckFullName("No Such Guy", "", "no match found");
CheckFullName("John", "", "more than one result");
```

Trong đoạn code đã được refactor, ngoài việc nhìn nó có tính thẩm mỹ hơn thì nó còn mang tới một số lợi ích sau:

- Chỉ cần lướt qua cũng có thể biết được có bao nhiêu case test.
- Loại bỏ rất nhiều code trùng lặp, làm cho code trở nên gọn gàng hơn.
- Thay vì kiểm tra error message xen kẽ với kiểm tra `ExpandFullName` khiến cho việc đọc code trở nên khó khăn thì chúng được kiểm tra trong method `CheckFullName`.
- Việc maintain sẽ trở nên dễ dàng hơn nhiều, khi muốn thêm một case test mới thì chỉ cần gọi `CheckFullName` với các tham số `partial_name`, `expected_full_name` và `expected_error`

## Sử dụng cách viết phân cột nếu cần thiết

Viết các đối số thành các cột giúp code dễ đọc hơn.

Quay lại ví dụ trước thì bạn có thể viết lại như sau:

```java showLineNumbers
CheckFullName("Doug Adams"  , "Mr. Douglas Adams" , "");
CheckFullName(" Jake Brown ", "Mr. Jake Brown III", "");
CheckFullName("No Such Guy" , ""                  , "no match found");
CheckFullName("John"        , ""                  , "more than one result");
```

Trong đoạn code trên thì việc phân biệt đối số thứ 2 và đối số thứ 3 trở nên rõ ràng hơn.

**Phân cột có thực sự cần ?**

Mặc dù phân cột giúp nhìn code thẩm mỹ hơn, tuy nhiên thì nhiều lập trình viên không thích nó (bao gồm cả mình), lý do là mất nhiều thời gian để căn chỉnh. Ngoài ra khi bạn thay đổi format của 1 dòng, thì bạn cũng phải thay đổi các dòng còn lại, khi đó thì những công cụ như github commit sẽ phát hiện ra nhiều thay đổi mà hầu hết chỉ toàn là space.

Bạn hãy cứ thử nó, nếu nó không mất nhiều công sức như bạn lo ngại, thì cứ áp dụng thôi 👌

## Chọn 1 thứ tự có nghĩa và duy trì một cách nhất quán:

Có nhiều trường hợp thì thứ tự không ảnh hưởng đến tính chính xác của chương trình, ví dụ chúng ta có 5 biến khai báo theo thứ tự bất kỳ:

```java showLineNumbers
details  = request.POST.get('details')
location = request.POST.get('location')
phone    = request.POST.get('phone')
email    = request.POST.get('email')
url      = request.POST.get('url')
```

Trong những tình huống như thế này, sẽ rất hữu ích nếu sắp xếp chúng theo một thứ tự có ý nghĩa nào đó chứ không chỉ ngẫu nhiên. Đây là một số ý tưởng:

- So khớp thứ tự của các biến với thứ tự của hiển thị trên UI
- Sắp xếp chúng theo độ quan trọng giảm dần.
- Sắp xếp chúng theo thứ tự bảng chữ cái.

Cho dù là thứ tự là như nào, thì bạn cần phải đảm bảo được tính nhất quán ở mọi nơi.

Thật khó hiểu nếu bạn định nghĩa ở một nơi khác như thế này:

```java showLineNumbers
if details:     rec.details  = details
if phone:       rec.phone    = phone      # Hey, where did 'location' go?
if email:       rec.email    = email
if url:         rec.url      = url
if location:    rec.location = location   # Why is 'location' down here now?
```

## Nhóm các lệnh khai báo thành từng khối

Bộ não suy nghĩ một cách tự nhiên về các nhóm và hệ thống phân cấp, vì vậy bạn có thể giúp người đọc tiêu hóa code của bạn một cách nhanh chóng hơn bằng cách tổ chức code theo cách này.

Ví dụ đoạn code C++ sau đây:

```c showLineNumbers
public:
    FrontendServer();
    void ViewProfile(HttpRequest* request);
    void OpenDatabase(string location, string user);
    void SaveProfile(HttpRequest* request);
    string ExtractQueryParam(HttpRequest* request, string param);
    void ReplyOK(HttpRequest* request, string html);
    void FindFriends(HttpRequest* request);
    void ReplyNotFound(HttpRequest* request, string error);
    void CloseDatabase(string location);
    ~FrontendServer();
};
```

Đoạn code trên không quá tệ, tuy nhiên bố cục chắc chắn không giúp người đọc hiểu được tất cả những phương thức trên.
Thay vì liệt kê tất cả các phương thức trong một khối khổng lồ, chúng nên được sắp xếp hợp lý thành các nhóm như sau:

```c showLineNumbers {6, 11, 16}
class FrontendServer {
    public:
        FrontendServer();
        ~FrontendServer();

        // Handlers
        void ViewProfile(HttpRequest* request);
        void SaveProfile(HttpRequest* request);
        void FindFriends(HttpRequest* request);

        // Request/Reply Utilities
        string ExtractQueryParam(HttpRequest* request, string param);
        void ReplyOK(HttpRequest* request, string html);
        void ReplyNotFound(HttpRequest* request, string error);

        // Database Helpers
        void OpenDatabase(string location, string user);
        void CloseDatabase(string location);
};
```

Phiên bản này dễ đọc hơn nhiều mặc dù nó có nhiều dòng hơn, lý do là nó được break nhỏ thành từng nhóm.

## Chia code có liên quan thành các đoạn riêng biệt ngăn cách với nhau

Mã nên được chia thành các “đoạn” vì những lý do sau:

- Đó là một cách để nhóm các ý tưởng tương tự lại với nhau và tách chúng ra khỏi những ý tưởng khác.
- Nó tạo điều kiện thuận lợi cho việc điều hướng từ đoạn này sang đoạn khác.

Ví dụ, không ai thích đọc một đoạn code khổng lồ như thế này:

```python showLineNumbers
# Import the user's email contacts, and match them to users in our system.
# Then display a list of those users that he/she isn't already friends with.
def suggest_new_friends(user, email_password):
    friends = user.friends()
    friend_emails = set(f.email for f in friends)
    contacts = import_contacts(user.email, email_password)
    contact_emails = set(c.email for c in contacts)
    non_friend_emails = contact_emails - friend_emails
    suggested_friends = User.objects.select(email__in=non_friend_emails)
    display['user'] = user
    display['friends'] = friends
    display['suggested_friends'] = suggested_friends
    return render("suggested_friends.html", display)
```

Tuy không rõ ràng, nhưng function này trải qua một số bước riêng biệt. Vì vậy sẽ dễ tiêu hoá hơn khi chia block code trên thành các đoạn và comment tóm tắt cho mỗi đoạn như sau:

```python showLineNumbers
def suggest_new_friends(user, email_password):
    # Get the user's friends' email addresses.
    friends = user.friends()
    friend_emails = set(f.email for f in friends)

    # Import all email addresses from this user's email account.
    contacts = import_contacts(user.email, email_password)
    contact_emails = set(c.email for c in contacts)

    # Find matching users that they aren't already friends with.
    non_friend_emails = contact_emails - friend_emails
    suggested_friends = User.objects.select(email__in=non_friend_emails)

    # Display these lists on the page.
    display['user'] = user
    display['friends'] = friends
    display['suggested_friends'] = suggested_friends
    return render("suggested_friends.html", display)
```

## Nhất quán, nhất quán, nhất quán.

Nhất quán, nhất quán, nhất quán, điều quan trọng phải được lặp lại 3 lần.

Tuy phong cách viết code của mỗi người là khác nhau, ví dụ có người sẽ thích viết code kiểu:

```js
class Logger {
 ...
};
```

Số còn lại thì sẽ là:

```js
class Logger
{
 ...
};
```

Dù bạn theo trường phái nào thì hãy duy trì tính nhất quán ở mọi nơi, đừng dùng style một cách "linh hoạt".

## Tổng kết

Tất cả mọi developer đều thích đọc code có tính thẩm mỹ, bằng cách định dạng code theo tính nhất quán, có ý nghĩa, việc đọc code sẽ trở nên dễ dàng và nhanh chóng hơn.

Sau đây là các kỹ thuật mà chúng ta đã cùng bàn luận:

- Các phần code tương tự nhau cũng cần trình bày giống nhau
- Sử dụng cách viết phân cột nếu cần thiết
- Chọn 1 thứ tự có nghĩa và duy trì một cách nhất quán
- Chia code có liên quan thành các đoạn riêng biệt ngăn cách với nhau, có thể thêm comment bổ sung cho từng đoạn.

Hy vọng sau bài viết này, bạn sẽ có những đoạn code mang tính thẩm mỹ hơn.
Happy coding!
